function Class(){}function capitalize(t){return t.charAt(0).toUpperCase()+t.slice(1)}function isNumeric(t){return!isNaN(parseFloat(t))&&isFinite(t)}Class.prototype.construct=function(){},Class.__asMethod__=function(i,n){return function(){var t=this.$;this.$=n;var e=i.apply(this,arguments);return this.$=t,e}},Class.extend=function(t){var e=function(){arguments[0]!==Class&&this.construct.apply(this,arguments)},i=new this(Class),n=this.prototype;for(var a in t){var s=t[a];s instanceof Function&&(s=Class.__asMethod__(s,n)),i[a]=s}return i.$=n,e.prototype=i,e.extend=this.extend,e},$.fn.highlight=function(t){return this.length&&t&&t.length?this.each(function(){!function t(e,i){var n=0;if(3==e.nodeType){var a=e.data.toUpperCase().indexOf(i);if(0<=(a-=e.data.substr(0,a).toUpperCase().length-e.data.substr(0,a).length)){var s=document.createElement("span");s.className="highlight";var o=e.splitText(a);o.splitText(i.length);var r=o.cloneNode(!0);s.appendChild(r),o.parentNode.replaceChild(s,o),n=1}}else if(1==e.nodeType&&e.childNodes&&!/(script|style)/i.test(e.tagName))for(var l=0;l<e.childNodes.length;++l)l+=t(e.childNodes[l],i);return n}(this,t.toUpperCase())}):this},$.fn.searchAble=function(i){var n="",a="",s=this,o=s.next(".glyphicon-remove");o.click(function(){s.val(""),s.trigger("keyup")}),s.on("keyup",function(t){var e=s.val();""==e?o.hide():o.show(),t.keyCode!=keyCode.ENTER?(n=e,setTimeout(function(){e==n&&e!=a&&i(a=e)},500)):i(a=e)})},$.fn.serializeObject=function(){var t={},e=this.serializeArray();return $.each(e,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t};var keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38,SHIFT:16,S:83},KikCmsClass=Class.extend({baseUri:null,translations:{},errorMessages:{},isDev:!1,maxFileUploads:null,maxFileSize:null,maxFileSizeString:null,windowManager:null,renderables:{},init:function(){"undefined"!=typeof moment&&moment.locale($("html").attr("lang"));var t=JSON.parse($("#kikCmsJsSettings").text());for(var e in t)this[e]=t[e];$("body").on("mouseover",".tt-suggestion",function(){$(".tt-suggestion").removeClass("tt-cursor"),$(this).addClass("tt-cursor")}),void 0!==WindowManager&&(this.windowManager=new WindowManager)},initRenderables:function(n){var a=this;n=void 0!==n?n:null,$("[data-renderable]").each(function(){var t=$(this);if("true"!=t.attr("data-rendered")){var e=$.parseJSON(t.attr("data-renderable")),i=e.properties.renderableInstance;a.renderables[i]=new window[e.class],$.each(e.properties,function(t,e){a.renderables[i][t]=e}),n&&(a.renderables[i].parent=n),a.renderables[i].init(),t.attr("data-rendered",!0)}})},action:function(t,e,n,i,a,s){var o=!1,r=this,l=0;s=void 0!==s?s:null,setTimeout(function(){0==o&&KikCMS.showLoader()},250);var d=$("html").attr("lang");d&&(e.activeLangCode=d);var c={url:t,type:"post",dataType:"json",data:e,cache:!1,success:function(t,e,i){o=!0,r.hideLoader(),n(t,e,i),r.initRenderables(s)},error:function(t){if(0==t.readyState&&0==t.status&&l<2)return l++,void h();o=!0,r.showError(t,i)}};void 0!==a&&a&&(c.cache=!1,c.contentType=!1,c.processData=!1,c.xhr=a);var h=function(){$.ajax(c)};h()},getSecurityToken:function(e){KikCMS.action("/cms/generate-security-token",{},function(t){e(t)})},showError:function(t,e){void 0!==e&&e(),this.hideLoader(),this.isDev&&440!=t.status?$("#ajaxDebugger").html(t.responseText).show():alert(t.responseJSON.title+"\n\n"+t.responseJSON.description)},showLoader:function(){this.getLoader().addClass("show")},hideLoader:function(){this.getLoader().removeClass("show")},getLoader:function(){return $("#cmsLoader")},removeExtension:function(t){return t.replace(/\.[^/.]+$/,"")},tl:function(t,e){var i=this.translations[t];return $.each(e,function(t,e){i=i.replace(new RegExp(":"+t,"g"),e)}),i},toSlug:function(t){t=t.replace(/^\s+|\s+$/g,"").toLowerCase();for(var e="àáäâèéëêìíïîòóöôùúüûñç·/_,:;",i=0,n=e.length;i<n;i++)t=t.replace(new RegExp(e.charAt(i),"g"),"aaaaeeeeiiiioooouuuunc------".charAt(i));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")}}),KikCMS=new KikCmsClass;$(function(){KikCMS.init(),KikCMS.initRenderables()});var DataTable=Class.extend({actionPath:"/cms/datatable/",renderableInstance:null,renderableClass:null,labels:null,currentSearch:null,currentFormInput:null,parentEditId:null,parentModel:null,parentRelationKey:null,sortDirection:null,sortColumn:null,restore:null,filePicker:null,$table:null,getDeleteConfirmMessage:function(t){var e=capitalize(KikCMS.tl("dataTable.delete.confirmOne",{itemSingular:this.labels[0]}));return 1<t&&(e=KikCMS.tl("dataTable.delete.confirm",{amount:t,itemPlural:this.labels[1]})),e},getFormGroups:function(){return this.getWindow().find("form :input").not(".datatable :input")},getFormSerialized:function(){return this.getFormGroups().serialize()},getThumbHoverContainer:function(){var t="body > .datatableThumbHoverContainer";return 0===$(t).length&&$("body").append('<div class="datatableThumbHoverContainer"></div>'),$(t)},init:function(){this.initTable(),this.initPagination(),this.initSearch(),this.initLanguageSwitch(),this.initButtons(),this.initKeyEvents(),this.initFilters(),this.initRestore()},initButtons:function(){var n=this,t=this.getDataTable().find(".toolbar .btn.delete"),e=this.getDataTable().find(".toolbar .btn.add"),i=this.getDataTable().find(".toolbar .btn.pick-image"),a=this.getDataTable().find(".toolbar .btn.upload");t.click(function(){if("disabled"!=$(this).attr("disabled")){var t=n.getSelectedIds();if(t){var e=t.length,i=n.getDeleteConfirmMessage(e);confirm(i)&&n.actionDelete(t)}}}),i.click(function(){n.actionPickImage()}),e.click(function(){n.actionAdd()}),new FileUploader({$container:a,$uploadButton:a,action:"/cms/datatable/uploadImages",addParametersBeforeUpload:function(t){return t.append("renderableInstance",n.renderableInstance),t.append("renderableClass",n.renderableClass),t},onSuccess:function(t){t.errors?alert(t.errors.join("\n\n")):(n.setTableContent(t.table,t.editedIds),n.setPagesContent(t.pagination))}}).init()},initFilters:function(){var t=this;this.getFilterForm().find("input, select").change(function(){t.actionPage(1)})},initImageThumbs:function(){var s=this,t=this.getDataTable().find("table tr td .thumb"),o=function(t){var e=$(window).scrollTop(),i=$(window).scrollLeft(),n=t.clientX+i+15,a=t.clientY+e+15;s.getThumbHoverContainer().css({left:n,top:a})};t.each(function(){var a=$(this),t=a.parent();t.hover(function(t){var e=s.getThumbHoverContainer();o(t);var i=a.attr("data-thumb-url"),n=i.split("?")[0].endsWith(".svg");e.toggleClass("svg",n),e.show(),e.html('<img alt="thumb" src="'+i+'" />')},function(){s.getThumbHoverContainer().hide()}),t.mousemove(o)}),t.click(function(t){window.open($(this).attr("data-url")),t.stopPropagation()})},initKeyEvents:function(){var e=this,i={},n=function(t){if((t.metaKey||t.ctrlKey)&&t.keyCode==keyCode.S){if(!e.windowIsActive()||!e.getForm().length||!e.getWindow().find(".saveAndClose").length)return!0;e.actionSave(!0),e.getWindow().find(".saveAndClose").addClass("active"),t.preventDefault()}},t=function(){var t=$(this).attr("id");i[t]||(i[t]=t,$(this.contentWindow.document).keydown(n))},a=function(){$("body").find("iframe").each(t),setTimeout(a,1e3)};a(),$(window).unbind("keydown."+this.renderableInstance),$(window).unbind("keypress."+this.renderableInstance),$(window).bind("keydown."+this.renderableInstance,n),$(window).bind("keypress."+this.renderableInstance,function(t){if(t.keyCode==keyCode.ESCAPE){if(!e.windowIsActive()||!e.getForm().length)return!0;e.attemptToCloseWindow()}})},initLanguageSwitch:function(){var t=this;this.getDataTable().find(".language select").change(function(){t.actionPage(t.getFilters().page)})},initPagination:function(){var i=this;this.getDataTable().find(".pagination a").click(function(){var t=$(this);if(t.parent().hasClass("active")||t.parent().hasClass("disabled"))return!1;var e=t.attr("data-page");i.actionPage(e)})},initSearch:function(){var i=this;this.getSearchField().searchAble(function(t){var e=i.getFilters();e.search=t,e.page=1,i.action("search",e,function(t){i.setTableContent(t.table),i.setPagesContent(t.pagination)})})},initSort:function(){var n=this,t=new SortControl;t.$dataTable=this.getDataTable(),t.onDrop=function(t,e,i){n.action("rearrange",{id:t,targetId:e,position:i},function(t){n.setTableContent(t.table)})},t.init()},initTable:function(){this.$table=this.getDataTable().find("table");var n=this,t=this.$table.find("tbody tr");t.find("td a").click(function(t){t.stopPropagation()}),t.find("td:not(.action)").click(function(){var t=$(this).parent();t.attr("data-prevent-click")||n.onRowClick(t)}),t.find("td.edit").click(function(){var t=$(this).find("input[name=id]").val();n.actionEdit(t)}),t.find("td.delete").click(function(){var t=$(this).attr("data-id");confirm(n.getDeleteConfirmMessage(1))&&n.actionDelete([t])}),t.find("td:not(.action)").on("dblclick",function(){n.onRowDblClick($(this).parent())});var e=this.getSearchField().val();e&&n.getDataTable().find(".table").find("td").highlight(e),this.getDataTable().find("thead td").click(function(){var t,e=$(this),i=e.attr("data-column");switch(e.attr("data-sort")){case"asc":t="desc";break;case"desc":i=t="";break;default:t="asc"}n.sortDirection=t,n.sortColumn=i,n.actionSort(i,t)}),this.initImageThumbs(),this.updateToolbar(),this.initTableCheckBoxes(),void 0!==SortControl&&this.initSort()},initTableCheckBoxes:function(){var a=this;this.$table.find("input.table-checkbox[type=checkbox]").click(function(t){t.stopPropagation()}).dblclick(function(t){t.stopPropagation()}).change(function(){var t=$(this),e=t.is(":checked"),i=t.parent().parent().attr("data-id"),n=t.attr("data-col");t.attr("readonly","readonly"),a.action("checkCheckbox",{editId:i,column:n,checked:e?1:0},function(){t.removeAttr("readonly")},function(){t.removeAttr("readonly")})})},initTabs:function(){var t=this.getWindow(),n=t.find(".tab-contents");t.find(".tabs .tab").each(function(){var t=$(this),e=t.attr("data-tab"),i=n.find(".tab-"+e);t.click(function(){t.siblings().removeClass("active"),t.addClass("active"),n.find(".tab-content").removeClass("active"),i.addClass("active")}),0<i.find(".has-error").length&&t.addClass("error")})},initRestore:function(){this.restore=new DataTableRestore(this)},initWindow:function(){var t=this,e=this.getWindow(),i=e.find(".header select[name=language]");this.initWindowSize(),this.initTabs(),e.find(".saveAndClose").click(function(){t.actionSave(!0)}),e.find(".save").click(function(){t.actionSave(!1)}),this.onChange(i,!0,function(){t.actionReloadWindow()}),this.currentFormInput=this.getFormSerialized(),$(window).resize(this.initWindowSize.bind(this)),this.restore.startPolling()},initWindowSize:function(){var t=this.getWindow(),e=t.find(".windowContent > .footer"),i=t.height(),n=t.find(".windowContent > .header").outerHeight(),a=0,s=e.length?e.outerHeight():0;0<t.find(".windowContent > .tabs").length&&(a=t.find(".windowContent > .tabs").outerHeight()),t.find(".content").css("height",i-n-s-a)},action:function(t,e,i,n){e=this.addActionParameters(e),KikCMS.action(this.actionPath+t,e,i,n,null,this)},actionAdd:function(t,e){var i=this,n=this.getFilters();if(void 0!==t)for(var a in t)n[a]=t[a];this.showWindow(),this.action("add",n,function(t){i.setWindowContent(t.window,e)},function(){i.closeWindow()})},actionDelete:function(t){var i=this,n=this.getFilters();n.ids=t,this.action("delete",n,function(t){if(t.error)alert(t.error);else{var e=parseInt(n.page);1<e&&$(t.table).hasClass("no-data")?i.actionPage(e-1):(i.setTableContent(t.table),i.setPagesContent(t.pagination))}})},actionEdit:function(t,e){var i=this,n=this.getFilters();this.showWindow(),n.editId=t,this.action("edit",n,function(t){i.setWindowContent(t.window,e)},function(){i.closeWindow()})},actionReloadWindow:function(t){var e=this.getFormEditId();e?this.actionEdit(e,t):this.actionAdd({},t)},actionPage:function(t){var e=this,i=this.getFilters();i.page=t,this.action("page",i,function(t){e.setTableContent(t.table),e.setPagesContent(t.pagination)})},actionPickImage:function(){var e=this;this.filePicker=new FilePicker(this.renderableInstance,this.getDataTable(),function(t){e.onPickFile(t)},!0),this.filePicker.open()},actionReload:function(e){var i=this,t=this.getFilters();this.action("page",t,function(t){i.setTableContent(t.table),i.setPagesContent(t.pagination),void 0!==e&&e()})},actionSave:function(n){var a=this,s=this.getWindow(),t=this.getFormGroups().serializeObject(),e=s.find(".file-picker:visible .file.selected");if(0<e.length)e.trigger("pick",function(){a.actionSave(n)});else{var o=s.find(".saveAndClose, .save");o.attr("disabled","disabled"),this.getFormEditId()&&(t.editId=this.getFormEditId()),$.extend(t,this.getFilters()),this.action("save",t,function(t,e,i){200==i.status&&(a.setTableContent(t.table,t.editedId),a.setPagesContent(t.pagination)),n&&200==i.status?a.closeWindow():(a.setWindowContent(t.window),s.find(".alert").hide().fadeIn()),o.removeAttr("disabled")},function(){o.removeAttr("disabled")})}},actionSort:function(t,e){var i=this,n=this.getFilters();n.sortColumn=t,n.sortDirection=e,n.page=1,this.action("sort",n,function(t){i.setTableContent(t.table),i.setPagesContent(t.pagination)})},addActionParameters:function(t){t.renderableInstance=this.renderableInstance,t.renderableClass=this.renderableClass,null!=this.parentEditId&&(t.parentEditId=this.parentEditId),null!=this.parentModel&&(t.parentModel=this.parentModel),null!=this.parentRelationKey&&(t.parentRelationKey=this.parentRelationKey);var e=this.getWindow().find(".tabs .tab.active").attr("data-tab");return void 0!==e&&(t.currentTab=e),t},attemptToCloseWindow:function(){null!=this.currentFormInput&&(this.contentHasChanged()&&!confirm(KikCMS.tl("dataTable.closeWarning"))||this.closeWindow())},closeWindow:function(){var t=this;this.restore.stopPolling(),KikCMS.windowManager.closeWindow(this.getWindow(),function(){$(".datatableThumbHoverContainer").remove(),"undefined"!=typeof tinymce&&tinymce.remove(t.getWysiwygSelector()),this.currentFormInput=null})},contentHasChanged:function(){return this.currentFormInput!=this.getFormSerialized()},onPickFile:function(t){var e=this,i=t.map(function(){return $(this).data("id")}).get();this.action("addImage",{fileIds:i},function(t){t.errors?alert(t.errors.join("\n\n")):(e.setTableContent(t.table,t.editedIds),e.setPagesContent(t.pagination))})},onRowClick:function(t){t.toggleClass("selected"),this.updateToolbar()},onRowDblClick:function(t){var e=t.find("input[name=id]").val();this.actionEdit(e)},showWindow:function(){KikCMS.windowManager.showWindow(this.getWindow())},setEdited:function(t){var i=this;if(Array.isArray(t))$.each(t,function(t,e){i.getDataTable().find("table tr[data-id="+e+"]").addClass("edited")}),e=i.getDataTable().find("table tr[data-id="+t[0]+"]");else{var e=this.getDataTable().find("table tr[data-id="+t+"]");e.addClass("edited")}if(setTimeout(function(){e.addClass("easeOutBgColor"),e.removeClass("edited"),setTimeout(function(){e.removeClass("easeOutBgColor")},500)},5e3),e.length&&!this.isSubDataTable()){var n=e.offset().top,a=$(window).height(),s=$(window).scrollTop();(s+a-250<n||n<s)&&$("body").animate({scrollTop:n-250},1e3)}},setPagesContent:function(t){this.getDataTable().find(".pages").html(t),this.initPagination()},setTableContent:function(t,e){this.getDataTable().find(".table").html(t),this.initTable(),e&&this.setEdited(e)},setWindowContent:function(t,e){this.getWindow().find(".windowContent").html(t),void 0!==e&&e(),this.initWindow()},getClassWithoutSlashes:function(){return this.renderableClass.replace(/\\/g,"")},getCurrentPage:function(){var t=this.getDataTable().find(".pagination .active a").attr("data-page");return t||1},getDataTable:function(){return $("#"+this.renderableInstance)},getFilters:function(){var t={};t.page=this.getCurrentPage(),t.search=this.getSearchField().val(),this.sortColumn&&this.sortDirection&&(t.sortDirection=this.sortDirection,t.sortColumn=this.sortColumn);var e=this.getLanguageCode(),i=this.getWindowLanguageCode();return e&&(t.languageCode=e),i&&(t.windowLanguageCode=i),t.customFilterValues=this.getFilterForm().find(":input").serializeObject(),t},getFilterForm:function(){return this.getDataTable().find(" > .filters")},getForm:function(){return this.getWindow().find("form")},getFormEditId:function(){return this.getWindow().find(".webForm").attr("data-id")},getLanguageCode:function(){return this.getDataTable().find(".toolbar .language select").val()},getWindowLanguageCode:function(){return this.getWindow().find(".header select[name=language]").val()},getSearchField:function(){return this.getDataTable().find(".toolbar .search input")},getSelectedIds:function(){var t=[];return this.getDataTable().find("tr.selected .edit input[name=id]").each(function(){t.push($(this).val())}),t},getWindow:function(){return KikCMS.windowManager.getWindow(this.renderableInstance,this.getDataTable(),this.attemptToCloseWindow.bind(this))},getWysiwygSelector:function(){return"#"+this.getWindow().find(".webForm").attr("id")+" textarea.wysiwyg"},isSubDataTable:function(){return 1<=this.getDataTable().parents(".dataTableWindow").length},onChange:function(t,e,i){var n,a,s=this;e=void 0===e||e,t.focus(function(){n=t.val(),a=s.getFormSerialized()}).change(function(){!e||s.currentFormInput==a||confirm(KikCMS.tl("dataTable.switchWarning"))?i():t.val(n)})},updateToolbar:function(){var t=this.getDataTable().find("tr.selected"),e=this.getDataTable().find(".toolbar .btn.delete");0<t.length?e.removeAttr("disabled"):e.attr("disabled","disabled")},windowIsActive:function(){return!this.getWindow().hasClass("blur")}}),DataTableRestore=Class.extend({dataTable:null,interval:null,storageIndex:null,pollInterval:1e4,isPolling:!1,construct:function(t){this.dataTable=t},determineStorageIndex:function(){var t=JSON.parse(localStorage.getItem(this.getStorageKey()));this.storageIndex=t?Math.max(Object.keys(t))+1:1},getContent:function(){return this.dataTable.getFormGroups().serializeObject()},getFormattedDateByRestoreObject:function(t){var e=t.date;return moment(e).format("dddd D MMMM YYYY, HH:mm")},getRestoreButton:function(){return this.dataTable.getWindow().find(".footer > .restore")},getStorageContent:function(){var t=localStorage.getItem(this.getStorageKey());return t?JSON.parse(t):{}},getStorageKey:function(){var t=this.dataTable.getFormEditId();return"kikcms.dt."+this.dataTable.getClassWithoutSlashes()+"."+(t||"new")},remove:function(t){var e=this.getStorageContent();delete e[t],0==Object.keys(e).length?localStorage.removeItem(this.getStorageKey()):localStorage.setItem(this.getStorageKey(),JSON.stringify(e))},restore:function(t){var i=this,e=this.getStorageContent()[t],n=this.getFormattedDateByRestoreObject(e);if(!confirm(KikCMS.tl("dataTable.restoreConfirm",{date:n})))return!1;$.each(e.content,function(t,e){i.restoreField(t,e)}),this.remove(t),this.getRestoreButton().find("[data-id="+t+"]").parent().remove(),this.getRestoreButton().find("li").length||this.getRestoreButton().hide()},restoreField:function(t,e){var i=this.dataTable.getForm().find('[name="'+t+'"]'),n=i.val();(i.val(e),n in KikCMS.renderables&&($("#"+n).attr("id",e),KikCMS.renderables[n].renderableInstance=e,KikCMS.renderables[n].actionPage(1)),i.parent().hasClass("type-file"))&&KikCMS.renderables[this.dataTable.getForm().parent().data("instance")].actionPickFile(i.parent(),e)},showButton:function(){var n=this.getRestoreButton(),t=this.getStorageContent(),a=this;n.show(),$.each(t,function(t,e){var i=a.getFormattedDateByRestoreObject(e);n.find("ul").append('<li><a data-id="'+t+'">'+i+"</a></li>")}),n.find("ul li a").click(function(){a.restore($(this).data("id"))})},startPolling:function(){var t=this,e=this.getContent(),i=this.getStorageContent();if(this.isPolling)return!1;this.isPolling=!0,this.determineStorageIndex(),0!==Object.keys(i).length&&this.showButton(),this.interval=setInterval(function(){t.dataTable.windowIsActive()&&(JSON.stringify(e)!==JSON.stringify(t.getContent())?t.store():t.remove(t.storageIndex))},this.pollInterval)},stopPolling:function(){this.isPolling=!1,this.remove(this.storageIndex),clearInterval(this.interval)},store:function(){var t=this.getStorageContent();t[this.storageIndex]={date:new Date,content:this.getContent()},localStorage.setItem(this.getStorageKey(),JSON.stringify(t))}}),SortControl=Class.extend({dragHoverClass:"dragHover",isDragging:!1,hoveringNode:!1,draggedObject:null,timeDragStarted:0,startX:0,startY:0,moveOnlyVertical:!0,selectedObjectX:0,selectedObjectY:0,$dataTable:null,onDrop:null,init:function(){var i=this,n=$(window),t=this.getHoverObjects(),e=this.getDraggables();e.on("selectstart",function(t){t.preventDefault()}),e.mousedown(function(t){1===t.which&&(i.draggedObject=$(this),i.selectedObjectX=i.getObjectToBeDragged().offset().left,i.selectedObjectY=i.getObjectToBeDragged().offset().top,i.startX=t.clientX+n.scrollLeft(),i.startY=t.clientY+n.scrollTop())}),t.hover(function(){i.isDragging&&$(this).addClass(i.dragHoverClass)},function(){i.isDragging&&($(this).removeClass(i.dragHoverClass),$(this).removeAttr("data-drop"))}),t.mousemove(function(t){if(i.isDragging){var e=$(this);i.isValidDropPosition(e,t.clientY)?e.attr("data-drop",i.getHoverPosition(t.clientY+n.scrollTop(),e)):e.removeAttr("data-drop")}}),n.mousemove(this.windowMouseMove.bind(this)),n.mouseup(this.endDrag.bind(this))},cloneSelectedObject:function(){var t=this.draggedObject.parent(),e=$("<table class='draggedObject rowClone'></table>").append(t.clone());return e.css("width",t.innerWidth()),t.find("td").each(function(t){e.find("td").eq(t).css("width",$(this).innerWidth())}),e},endDrag:function(){if(this.draggedObject){var t=this.getSelectedRow();this.isDragging&&(t.attr("data-prevent-click",1),setTimeout(function(){t.removeAttr("data-prevent-click")}));var e=this.getHoverObjects();this.isDragging=!1,this.getDragObject().remove();var i=this.$dataTable.find("."+this.dragHoverClass),n=250<(new Date).getTime()-this.timeDragStarted;if(i.length&&this.onDrop&&n){var a=i.attr("data-id"),s=i.attr("data-drop"),o=t.attr("data-id");s&&this.onDrop(o,a,s)}t.removeClass("dragged"),this.draggedObject=null,e.find(".name").removeClass(this.dragHoverClass),e.removeClass(this.dragHoverClass),$("body").removeClass("noSelect").removeClass("isDragging")}},getDragObject:function(){var t=$(".draggedObject");return t.length||((t=this.cloneSelectedObject()).addClass("draggedObject"),$("body").append(t)),t},getHoverPosition:function(t,e){var i=e.outerHeight();return t>e.offset().top+i/2?"after":"before"},getObjectToBeDragged:function(){return this.getSelectedRow()},getSelectedRow:function(){return this.draggedObject.parent()},getDraggables:function(){return this.$dataTable.find("tbody tr td.sort")},getHoverObjects:function(){return this.$dataTable.find("tbody tr")},isDraggingAndNotCurrent:function(t){return!!this.isDragging&&!t.hasClass("dragged")},isValidDropPosition:function(t,e){var i=this.getHoverPosition(e,t);return("after"!=i||t.next()[0]!=this.getSelectedRow()[0])&&(("before"!=i||t.prev()[0]!=this.getSelectedRow()[0])&&t[0]!=this.getSelectedRow()[0])},windowMouseMove:function(t){var e=$(window),i=t.clientX+e.scrollLeft(),n=t.clientY+e.scrollTop();if(this.isDragging){var a=this.getDragObject(),s=this.moveOnlyVertical?this.selectedObjectX:i-(this.startX-this.selectedObjectX);a.css("left",s),a.css("top",n-(this.startY-this.selectedObjectY))}else if(this.draggedObject){var o=i>this.startX+5||i<this.startX-5,r=n>this.startY+5||n<this.startY-5;(o||r)&&(this.isDragging=!0,this.timeDragStarted=(new Date).getTime(),this.getSelectedRow().addClass("dragged"),$("body").addClass("noSelect").addClass("isDragging"))}}}),TreeSortControl=SortControl.extend({moveOnlyVertical:!1,hoveringNode:!1,init:function(){this.$.init.call(this);var t=this;this.getDraggables().hover(function(){t.hoveringNode=!0},function(){t.hoveringNode=!1})},cloneSelectedObject:function(){return this.draggedObject.clone()},getDraggables:function(){return this.getHoverObjects().find(".name")},getObjectToBeDragged:function(){return this.draggedObject},getHoverObjects:function(){return this.$dataTable.find(".pageObject")},getHoverPosition:function(t,e){return this.hoveringNode&&this.mayDropInto(e)?"into":this.$.getHoverPosition.call(this,t,e)},getParentRow:function(){var t=this.getSelectedRow(),e=t.attr("data-level");return t.prevAll(".level"+(e-1)+":first")},getSelectedRow:function(){return this.draggedObject.parent().parent()},isValidDropPosition:function(t,e){return!t.hasClass("dragged")&&e},mayDropInto:function(t){var e=parseInt(t.attr("data-level")),i=this.getParentRow();if(i&&i.attr("data-id")==t.attr("data-id"))return!1;if(t.hasClass("detached"))return!1;if(0<e&&t.prevAll(".level0:first").attr("data-max-level")<=e)return!1;return!0}}),FilePicker=Class.extend({instance:null,$element:null,onPickFile:null,multi:!1,construct:function(t,e,i,n){this.instance=t,this.onPickFile=i,this.$element=e,this.multi=n},close:function(){KikCMS.windowManager.closeWindow(this.getWindow())},initWindow:function(t){var e=this,i=this.getWindow(),n=i.find(".windowContent");n.html(t),n.unbind("pick"),n.unbind("selectionChange"),$(window).unbind("keypress."+this.instance);var a=i.find(".pick-file");KikCMS.windowManager.showWindow(i),this.initWindowSize(),$(window).resize(this.initWindowSize.bind(this)),n.on("pick",".file",function(){e.pickFile($(this))}),n.on("selectionChange",".file",function(){var t=n.find(".file.selected:not(.folder)").length;1<=t?a.removeClass("disabled"):a.addClass("disabled"),1<t?a.find(".amount").html(" ("+t+")"):a.find(".amount").html("")}),a.click(function(){a.hasClass("disabled")||e.pickFile(n.find(".file.selected"))});$(window).bind("keypress."+this.instance,function(t){t.keyCode==keyCode.ESCAPE&&i.is(":visible")&&KikCMS.windowManager.closeWindow(i)})},initWindowSize:function(){var t=this.getWindow(),e=t.find(".windowContent > .footer"),i=t.find(".windowContent > .header"),n=t.height(),a=i.outerHeight(),s=e.outerHeight();t.find(".files").css("height",n-a-s-132)},open:function(){var e=this;this.getWindow().on("click",".buttons .cancel",function(){e.close()}),KikCMS.action("/cms/webform/getFinder",{multi:this.multi},function(t){e.initWindow(t.finder)})},pickFile:function(t){t.removeClass("selected"),this.onPickFile(t),this.close()},getWindow:function(){return KikCMS.windowManager.getWindow(this.instance+"FilePicker",this.$element)}}),Finder=Class.extend({renderableInstance:null,renderableClass:null,shiftKeyPressed:!1,pickingMode:!1,multiPick:!1,cutFileIds:[],permission:null,action:function(t,e,i){void 0===e.folderId&&(e.folderId=this.getCurrentFolderId()),e.renderableInstance=this.renderableInstance,e.renderableClass=this.renderableClass,KikCMS.action("/cms/finder/"+t,e,i)},actionAddFolder:function(){var e=this,t=prompt(KikCMS.tl("media.createFolder"),KikCMS.tl("media.defaultFolderName"));t&&this.action("createFolder",{folderName:t},function(t){e.setFilesContainer(t.files,t.fileIds)})},actionCut:function(){this.cutFileIds=this.getSelectedFileIds(),this.initCutFiles()},actionDelete:function(){var i=this,t=this.getSelectedFileIds(),e=1<t.length?KikCMS.tl("media.deleteConfirm",{amount:t.length}):KikCMS.tl("media.deleteConfirmOne");confirm(e)&&this.action("delete",{fileIds:t},function(t){if(t.errorMessages)for(var e in t.errorMessages)alert(t.errorMessages[e]);t.files&&i.setFilesContainer(t.files)})},actionEditFileName:function(t){var e=this,i=t.attr("data-id"),n=KikCMS.removeExtension(t.find(".name span").text()),a=prompt(KikCMS.tl("media.editFileName"),n);a&&this.action("editFileName",{fileId:i,fileName:a},function(t){e.setFilesContainer(t.files,t.fileIds)})},actionPaste:function(){var e=this;this.action("paste",{fileIds:this.cutFileIds},function(t){e.cutFileIds=[],e.setFilesContainer(t.files,t.fileIds)})},actionOpenFolder:function(e){var i=this;this.action("openFolder",{folderId:e},function(t){i.saveCurrentFolderId(e),i.setFilesContainer(t.files),i.setPath(t.path)})},fileDeSelect:function(t){t.removeClass("selected"),t.trigger("selectionChange"),this.updateToolbar()},fileSelect:function(t){t.addClass("selected"),t.trigger("selectionChange"),this.updateToolbar()},init:function(){this.initUpload(),this.initFiles(),this.initKeyEvents(),this.initPermissions(),this.initButtons(),this.initSearch(),this.initPath()},initButtons:function(){this.getToolbar().find(".delete").click(this.actionDelete.bind(this)),this.getToolbar().find(".addFolder").click(this.actionAddFolder.bind(this)),this.getToolbar().find(".cut").click(this.actionCut.bind(this)),this.getToolbar().find(".paste").click(this.actionPaste.bind(this)),this.getToolbar().find(".download").click(this.download.bind(this)),this.getToolbar().find(".rights").click(this.permission.openModal.bind(this.permission))},initCutFiles:function(){var i=this;i.getFileContainer().find(".file").removeClass("cut"),$.each(this.cutFileIds,function(t,e){i.getFileContainer().find(".file-"+e).addClass("cut")}),this.updateToolbar()},initFiles:function(){var i=this,n=this.getFileContainer(),t=n.find(".file");t.each(function(){var e=$(this),t=e.find("img, .glyphicon, .extension, .name span");e.find(".thumb").click(function(t){$(this).parent().hasClass("selected")&&(t.stopPropagation(),i.shiftKeyPressed&&i.fileDeSelect(e))}),e.find(".name span").click(function(){e.hasClass("selected")&&setTimeout(function(){e.attr("data-double-clicked")||i.actionEditFileName(e)},500)}),e.find("img").on("dragstart",function(t){t.preventDefault()}),t.click(function(t){(!i.shiftKeyPressed||i.pickingMode&&!i.multiPick)&&n.find(".file.selected").removeClass("selected"),e.hasClass("selected")&&i.shiftKeyPressed?i.fileDeSelect(e):i.fileSelect(e),t.stopPropagation()}),t.on("dblclick",function(t){if(e.attr("data-double-clicked",!0),setTimeout(function(){e.removeAttr("data-double-clicked")},500),e.hasClass("folder"))return i.actionOpenFolder(e.attr("data-id")),void t.stopPropagation();i.pickFile(e),t.stopPropagation()})}),t.on("dblclick",function(){var t=$(this);t.hasClass("folder")?i.actionOpenFolder(t.attr("data-id")):t.hasClass("selected")&&i.pickFile(t)}),this.getFileContainer().click(function(){if(!i.shiftKeyPressed){var t=n.find(".file.selected");i.fileDeSelect(t)}}),this.updateToolbar(),this.initCutFiles()},initKeyEvents:function(){var e=this;$(document).keydown(function(t){t.keyCode==keyCode.SHIFT&&(e.shiftKeyPressed=!0)}),$(document).keyup(function(t){t.keyCode==keyCode.SHIFT&&(e.shiftKeyPressed=!1)})},initPath:function(){var e=this;this.getFinder().find(".path ul li a").click(function(){var t=$(this).attr("data-id");e.actionOpenFolder(t)})},initPermissions:function(){this.permission=new FinderPermission(this),this.permission.init()},initSearch:function(){var i=this;this.getSearchField().searchAble(function(e){i.action("search",{search:e},function(t){i.setFilesContainer(t.files),i.setPath(t.path),i.getFileContainer().find(".file .name span").highlight(e)})})},initUpload:function(){var e=this,t={$container:this.getFinder(),onSuccess:function(t){e.setFilesContainer(t.files,t.fileIds)},addParametersBeforeUpload:function(t){return t.append("folderId",e.getCurrentFolderId()),t.append("renderableInstance",e.renderableInstance),t.append("renderableClass",e.renderableClass),t}};new FileUploader(t).init(),t.$uploadButton=this.getFinder().find(".btn.overwrite"),t.addParametersBeforeUpload=function(t){return t.append("overwriteFileId",e.getSelectedFileIds()[0]),t.append("renderableInstance",e.renderableInstance),t.append("renderableClass",e.renderableClass),t},new FileUploader(t).init()},download:function(){this.getSelectedFiles().trigger("dblclick")},getFinder:function(){return $("#"+this.renderableInstance)},getFileContainer:function(){return this.getFinder().find(".files .files-container")},pickFile:function(t){this.pickingMode?t.trigger("pick"):window.open(t.attr("data-url"))},setFilesContainer:function(t,e){var n=this.getFileContainer();n.html(t),this.initFiles(),$.each(e,function(t,e){if(!1!==e){var i=n.find(".file-"+e);i.addClass("edited"),setTimeout(function(){i.find(".thumb").addClass("easeOutBgColor"),i.removeClass("edited"),setTimeout(function(){i.find(".thumb").removeClass("easeOutBgColor")},500)},5e3)}})},setPath:function(t){this.getFinder().find(".path").html(t),this.initPath()},getSearchField:function(){return this.getToolbar().find(".search input")},getSelectedFileIds:function(){var t=[];return this.getSelectedFiles().each(function(){t.push($(this).attr("data-id"))}),t},getSelectedFiles:function(){return this.getFileContainer().find(".file.selected")},getToolbar:function(){return this.getFinder().find(".toolbar")},getCurrentFolderId:function(){return this.getFinder().find("input.currentFolderId").val()},saveCurrentFolderId:function(t){this.getFinder().find("input.currentFolderId").val(t)},selectedSingleFolder:function(){var t=this.getSelectedFiles();return!(1<t.length)&&t.hasClass("folder")},updateToolbar:function(){var t=this,e=this.getToolbar();1!==this.getSelectedFileIds().length||this.selectedSingleFolder()?(e.find(".download").fadeOut(),e.find(".overwrite").fadeOut()):(e.find(".download").fadeIn(),e.find(".overwrite").fadeIn()),1<=this.getSelectedFileIds().length?(this.selectedSingleFolder()?setTimeout(function(){1<=t.getSelectedFileIds().length&&e.find(".delete, .cut").fadeIn()},250):e.find(".delete, .cut").fadeIn(),e.find(".rights").fadeIn()):e.find(".delete, .cut, .rights").fadeOut(),0<this.cutFileIds.length?e.find(".paste").fadeIn():e.find(".paste").fadeOut()}}),FinderPermission=Class.extend({finder:null,construct:function(t){this.finder=t},init:function(){var t=this,e=this.getModal(),i=this.getForm();e.find(".save").click(this.onSaveButtonClick.bind(this)),i.on("change",".check input",function(){t.updateDependentCheckboxes($(this))}),i.on("change","select",function(){t.onUserSelect($(this))})},getForm:function(){return this.getModal().find(".form")},getModal:function(){return $("#permissionModal"+this.finder.renderableInstance)},getMessageContainer:function(){return this.getModal().find(".messages")},openModal:function(){var e=this;KikCMS.action("/cms/finder/permission/get",{fileIds:this.finder.getSelectedFileIds()},function(t){e.updateModal(t),e.getModal().appendTo("body").modal()})},updateDependentCheckboxes:function(t){var e=t.attr("data-right"),i=t.parent().parent().next().find("input"),n=t.parent().parent().prev().find("input");"write"==e&&t.prop("checked")&&(n.prop("indeterminate",!1),n.prop("checked",!0)),"write"==e&&t.prop("indeterminate")&&n.prop("indeterminate",!0),"read"!=e||t.prop("checked")||(i.prop("checked",!1),i.prop("indeterminate",!1))},updateModal:function(t){var e=this.getModal(),i=this.finder.getSelectedFiles();e.find(".modal-title .file").html(t.title),e.find(".messages .alert").hide(),e.find("input").prop("indeterminate",!1),e.find("input").prop("checked",!1),e.find(".sub-files-checkbox").toggle(i.hasClass("folder")),this.resetUserValues();var n=e.find("table tr:last");$.each(t.table,function(a,s){if(isNumeric(a)){var t=n.clone();t.find("select").val(a),t.find("input").removeAttr("disabled"),t.find("input:first").attr("name","permission["+a+"][read]").attr("data-right","read"),t.find("input:last").attr("name","permission["+a+"][write]").attr("data-right","write"),n.before(t)}$.each(["read","write"],function(t,e){var i=s[e],n=$('input[name="permission['+a+"]["+e+']"]');switch(n.removeAttr("disabled"),i){case 2:n.prop("indeterminate",!0).trigger("change");break;case 1:n.prop("checked",!0).trigger("change")}s.disabled&&n.attr("disabled",!0)})})},onSaveButtonClick:function(){var t=!1,e=this.getMessageContainer(),i=e.find(".alert"),n=e.find(".warning"),a=e.find(".success"),s=e.find(".error");if(this.getForm().find("input").each(function(){$(this).prop("indeterminate")&&(t=!0)}),t)return i.hide(),void n.fadeIn();var o=this.getForm().find(":input").serializeObject();o.fileIds=this.finder.getSelectedFileIds(),KikCMS.action("/cms/finder/permission/update",o,function(t){i.hide(),1==t.success?a.fadeIn():s.fadeIn()})},onUserSelect:function(t){var e=t.val(),i=t.parent().parent();if(e){if(!i.next().length){var n=i.clone();this.getForm().find("table").append(n)}i.find("input").removeAttr("disabled"),i.find("input:first").attr("name","permission["+e+"][read]").attr("data-right","read"),i.find("input:last").attr("name","permission["+e+"][write]").attr("data-right","write")}else i.next().length&&i.remove()},resetUserValues:function(){var e=this.getModal();e.find("select").each(function(){var t=$(this);(t.val()||1<e.find("select").length)&&t.parent().parent().remove()})}}),FileUploader=function(t){this.onSuccess=t.onSuccess,this.$container=t.$container,this.$uploadButton=t.$uploadButton?t.$uploadButton:this.$container.find(".upload"),this.action=t.action?t.action:"/cms/finder/upload",this.fileTypes=t.fileTypes?t.fileTypes:[],t.addParametersBeforeUpload?this.addParametersBeforeUpload=t.addParametersBeforeUpload:this.addParametersBeforeUpload=function(t){return t}};FileUploader.prototype={init:function(){var s=this;this.$uploadButton.find("input").on("click",function(t){s.$uploadButton.hasClass("disabled")&&t.preventDefault()}),this.$uploadButton.find("input").on("change",function(){var t=new FormData,e=this.files.length,i=0;if(e>KikCMS.maxFileUploads)alert(KikCMS.tl("media.uploadMaxFilesWarning",{amount:KikCMS.maxFileUploads}));else{for(var n=0;n<e;n++){var a=this.files[n];a.size>KikCMS.maxFileSize?alert(KikCMS.tl("media.uploadMaxFileSizeWarning",{max:KikCMS.maxFileSizeString})):(t.append("files[]",a),i++)}s.checkFileTypes(this.files)&&i&&s.actionUpload(t)}})},actionUpload:function(t){var e=this,i=this.$container.find(".progress-bar");this.$uploadButton.addClass("disabled"),i.parent().fadeIn(),t=this.addParametersBeforeUpload(t),KikCMS.action(this.action,t,function(t){e.onSuccess(t),t.errors&&0<t.errors.length&&alert(t.errors.join("\n")),e.$uploadButton.removeClass("disabled"),e.$uploadButton.find("input").val(""),i.parent().fadeOut()},function(){e.$uploadButton.removeClass("disabled"),e.$uploadButton.find("input").val(""),i.parent().fadeOut()},function(){var t=$.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",function(t){var e=t.position/t.totalSize*100;i.width(e+"%"),i.attr("aria-valuenow",e)},!1),t})},checkFileTypes:function(t){for(var e=0;e<t.length;e++)for(var i=t[e].name,n=0;n<this.fileTypes.length;n++){var a=this.fileTypes[e];if(i.substr(i.length-a.length,a.length).toLowerCase()!=a.toLowerCase())return void alert(KikCMS.tl("media.fileTypeWarning")+this.fileTypes.join(", "))}return!0}};var WebForm=Class.extend({renderableInstance:null,renderableClass:null,parent:null,actionPreview:function(t,e,i,n){var a=t.find(".preview"),s=t.find(".preview .thumb"),o=t.find(".buttons .pick"),r=t.find(".buttons .delete"),l=t.find(".filename");i.dimensions?(s.css("width",i.dimensions[0]/2),s.css("height",i.dimensions[1]/2)):(s.css("width","auto"),s.css("height","auto")),a.removeClass("hidden"),s.html(i.preview),l.html("("+i.name+")"),t.find(" > input[type=hidden].fileId").val(e),o.addClass("hidden"),r.removeClass("hidden"),void 0!==n&&n()},createFilePicker:function(e){var i=this;return new FilePicker(this.renderableInstance,this.getWebForm(),function(t){i.onPickFile(t,e)})},init:function(){this.initAutocompleteFields(),this.initDateFields(),this.initFileFields(),this.initWysiwyg(),this.initPopovers()},initAutocompleteFields:function(){var a=this;this.getWebForm().find(".autocomplete").each(function(){var e=$(this),t=e.attr("data-field-key"),i=e.attr("data-route"),n={field:t,renderableInstance:a.renderableInstance,renderableClass:a.renderableClass};KikCMS.action(i,n,function(t){a.initAutocompleteData(t,e)})})},initAutocompleteData:function(t,e){var a;e.typeahead({hint:!0,highlight:!0},{limit:10,source:(a=t,function(t,e){var i=[],n=new RegExp(t,"i");$.each(a,function(t,e){n.test(e)&&i.push(e)}),e(i)})})},initDateFields:function(){this.getWebForm().find(".type-date input").each(function(){var t=$(this);if(t.datetimepicker({format:t.attr("data-format"),locale:moment.locale(),useCurrent:!1}),t.attr("data-default-date")){var e=t.val(),i=moment(t.attr("data-default-date"),t.attr("data-format"));t.datetimepicker("defaultDate",i),e||t.val("")}})},initFileFields:function(){var r=this;this.getWebForm().find(".type-file").each(function(){var t=$(this),e=t.find(".file-picker"),i=t.find(".btn.upload"),n=t.find(".btn.delete"),a=t.find(".btn.pick"),s=t.find(".btn.preview"),o=t.find(".btn.pick, .btn.preview");r.initUploader(t),n.click(function(){t.find(".filename").html(""),t.find(" > input[type=hidden].fileId").val(""),a.removeClass("hidden"),n.addClass("hidden"),s.find("img").remove(),s.addClass("hidden")}),o.click(function(){if(0!=$(this).attr("data-finder")){if(1<=e.find(".finder").length)return e.slideToggle(),void i.toggleClass("disabled");r.filePicker=r.createFilePicker(t),r.filePicker.open()}})})},initPopovers:function(){this.getWebForm().find('[data-toggle="popover"]').each(function(){var t=$(this).attr("data-content");$(this).popover({placement:"auto bottom",html:!0,content:t,container:"body"})})},initTinyMCE:function(){var e=this;tinymce.init({selector:this.getWysiwygSelector(),setup:function(t){t.on("change",function(){tinymce.triggerSave()})},language_url:"/cmsassets/tinymce/"+KikCMS.tl("system.langCode")+".js",language:KikCMS.tl("system.langCode"),theme:"modern",relative_urls:!1,remove_script_host:!0,document_base_url:KikCMS.baseUri,plugins:["advlist autolink lists link image charmap print preview hr anchor pagebreak searchreplace visualblocks","visualchars code insertdatetime media nonbreaking save table contextmenu directionality template paste","textcolor colorpicker textpattern codesample toc"],image_advtab:!0,content_css:["/cmsassets/css/tinymce_content.css"],link_list:this.getLinkListUrl(),file_picker_callback:function(t){e.getFilePicker(t)}})},initUploader:function(e){var i=this;new FileUploader({$container:e,action:"/cms/webform/uploadAndPreview",addParametersBeforeUpload:function(t){return t.append("folderId",e.find(".btn.upload").attr("data-folder-id")),t.append("renderableInstance",i.renderableInstance),t.append("renderableClass",i.renderableClass),t},onSuccess:function(t){t.fileId&&i.actionPreview(e,t.fileId,t)}}).init()},initWysiwyg:function(){var t=this;0!=$(this.getWysiwygSelector()).length&&("undefined"==typeof tinymce?$.getScript("//cdn.tinymce.com/4/tinymce.min.js",function(){window.tinymce.dom.Event.domLoaded=!0,tinymce.baseURL="//cdn.tinymce.com/4",tinymce.suffix=".min",t.initTinyMCE()}):this.initTinyMCE())},getFilePicker:function(i){var e=function(e){var t=e.attr("data-id");KikCMS.action("/cms/file/url/"+t,{},function(t){i(t.url,{alt:e.find(".name span").text()}),n.close()})},t=this.getWindowHeight()<768?this.getWindowHeight()-130:768,n=tinymce.activeEditor.windowManager.open({title:"Image Picker",url:"/cms/filePicker",width:952,height:t,buttons:[{text:"Insert",onclick:function(){var t=$(n.$el).find("iframe")[0].contentWindow.$(".filePicker").find(".file.selected");if(!t.length)return!1;e(t)}},{text:"Close",onclick:"close"}]});n.on("open",function(){$(n.$el).find("iframe").on("load",function(){this.contentWindow.$(".filePicker").on("pick",".file",function(){e($(this))})})})},getLinkListUrl:function(){var t="/cms/getTinyMceLinks/";return this.parent&&this.parent.getWindowLanguageCode()?t+this.parent.getWindowLanguageCode()+"/":t},getWebForm:function(){return $("[data-instance="+this.renderableInstance+"]")},getWindowHeight:function(){return $(window).height()},getWysiwygSelector:function(){return"#"+this.getWebForm().attr("id")+" textarea.wysiwyg"},getUploadButtonForFileField:function(t){return t.find(".btn.upload")},onPickFile:function(t,e){var i=this,n=t.attr("data-id"),a=this.getUploadButtonForFileField(e);t.removeClass("selected"),a.removeClass("disabled"),KikCMS.action("/cms/webform/filepreview/"+n,{},function(t){i.actionPreview(e,n,t)})},removeExtension:function(t){return t.replace(/\.[^/.]+$/,"")}}),PagesDataTable=DataTable.extend({actionPath:"/cms/datatable/pages/",closedPageIdsCacheKey:"kikcms.closedPageIds",cachedFieldValues:{},contentHasChanged:function(){return!!this.$.contentHasChanged.call(this)||!$.isEmptyObject(this.cachedFieldValues)},closeWindow:function(){this.$.closeWindow.call(this),this.cachedFieldValues={}},init:function(){this.$.init.call(this),this.initPageTypeMenu()},initWindow:function(){var n=this;this.$.initWindow.call(this),this.onChange(this.getTemplateField(),!1,function(){var i=n.getFormGroups().serializeObject();$.each(i,function(t,e){n.cachedFieldValues[t]=e}),n.actionReloadWindow(function(){n.getFormGroups().each(function(){var t=$(this),e=t.attr("name");e in n.cachedFieldValues&&t.val()!=i[e]&&t.val(n.cachedFieldValues[e])})})})},initPageTypeMenu:function(){var t=this;this.getDataTable().find(".pageTypes ul li a").click(function(){t.actionAdd({pageType:$(this).attr("data-type")})})},initTable:function(){this.$.initTable.call(this),this.initTreeSortControl(),this.initRowsCollapse(),this.updateEvenOdd(),$(".action.preview").click(function(){var t=$(this).parent().attr("data-plid");window.open("/cms/preview/"+t)})},initRowCollapse:function(e){var i=this,n=parseInt(e.attr("data-level"));parseInt(e.next().attr("data-level"))==n+1&&e.addClass("hasChildren"),e.find(".arrow").click(function(t){i.onCollapseArrowClick(t,$(this),e,n)}).on("dblclick",function(t){t.stopPropagation()})},initRowsCollapse:function(){var t=this;this.getRows().each(function(){t.initRowCollapse($(this))})},initTreeSortControl:function(){var t=new TreeSortControl;t.$dataTable=this.getDataTable(),t.onDrop=this.onPageDrop.bind(this),t.init()},actionSave:function(t){var e=this.getForm().find('input[name="pageLanguage*:name"]').val();"link"!=this.getForm().find("input[name=type]").val()&&this.getForm().find('input[name="pageLanguage*:slug"]').each(function(){$(this).val()||$(this).val(KikCMS.toSlug(e))}),this.$.actionSave.call(this,t)},getFilters:function(){var t=this.$.getFilters.call(this);return this.getTemplateField().each(function(){t.template=$(this).val()}),this.getWindow().find("input[name=type]").each(function(){t.pageType=$(this).val()}),t},getRows:function(){return this.$table.find("tbody tr")},onCollapseArrowClick:function(t,i,e,n){t.stopPropagation(),i.toggleClass("closed");var a=null;e.nextAll().each(function(){var t=$(this),e=parseInt(t.attr("data-level"));return null!==a&&a<=e||(a=null,!i.hasClass("closed")&&t.find(".arrow").hasClass("closed")&&(a=e+1),n<e&&void t.toggleClass("collapsed",i.hasClass("closed")))}),this.updateEvenOdd(),this.updateClosedIdsSetting()},onPageDrop:function(t,e,i){var n=this,a=this.getFilters();a.pageId=t,a.targetPageId=e,a.position=i,a=this.addActionParameters(a),KikCMS.action("/cms/datatable/pages/tree-order",a,function(t){n.setTableContent(t.table)})},getTemplateField:function(){return this.getWindow().find("#template")},updateClosedIdsSetting:function(){var t=[];this.$table.find("tbody tr").each(function(){$(this).find(".arrow.closed").length&&t.push($(this).attr("data-id"))}),KikCMS.action("/cms/user-settings/update-closed-page-ids",{ids:t,className:this.renderableClass},function(t){t.success||console.error("Failed storing closedPageIds")})},updateEvenOdd:function(){var t=this.getRows();t.removeClass("even").removeClass("odd"),t.filter(":visible:even").addClass("even"),t.filter(":visible:odd").addClass("odd")}}),PagesFlatDataTable=PagesDataTable.extend({getFilters:function(){var t=this.$.getFilters.call(this);return t.template=this.template,t}}),SelectDataTable=DataTable.extend({getFilters:function(){var t=this.$.getFilters.call(this);return t.selectedValues=this.getSelectionFromInput(),t},getInputField:function(){return this.getDataTable().next()},getSelectionFromInput:function(){var t=[];return this.getInputField().val()&&(t=JSON.parse(this.getInputField().val())),t},initTable:function(){this.$.initTable.call(this),this.selectCheckBoxes(),this.initCheckBoxes()},initCheckBoxes:function(){var a=this;this.getDataTable().find("td.select input").change(function(){var t=$(this),e=t.parent().parent().attr("data-id"),i=a.getSelectionFromInput();if(t.prop("checked"))i.push(e);else{var n=i.indexOf(e);-1<n&&i.splice(n,1)}a.getInputField().val(JSON.stringify(i))})},onRowClick:function(t){var e=t.find(".select input");e.prop("checked",!e.prop("checked")),e.change()},onRowDblClick:function(t){},selectCheckBoxes:function(){var i=this,t=this.getSelectionFromInput();$.each(t,function(t,e){i.getDataTable().find(".table tr[data-id="+e+"]").each(function(){$(this).find(".select input").prop("checked",!0)})})}}),TranslationsDataTable=DataTable.extend({initWindow:function(){this.$.initWindow.call(this),this.initKeyField()},initKeyField:function(){var t=this,e=this.getForm().find("select[name=key]");this.updateTranslationFields(e.val()),e.change(function(){t.updateTranslationFields($(this).val())})},updateTranslationFields:function(t){var i=this;KikCMS.action("/cms/getTranslationsForKey",{key:t},function(t){t&&$.each(t,function(t,e){i.getForm().find("textarea[data-language-code="+t+"]").val(e)})})}}),Statistics=Class.extend({ATTR_INTERVAL:"data-interval",CLASS_BTN_DEFAULT:"btn-default",CLASS_BTN_PRIMARY:"btn-primary",CLASS_FAILED:"failed",CLASS_GLOW:"glow",CLASS_LOADING:"loading",CLASS_START:"start",COLOR_PINK:"#3669c9",COLOR_BLUE:"#df137a",STR_FETCHING_NEW_DATA:null,STR_FETCHING_FAILED:null,STR_FETCH_NEW_DATA:null,STR_VISITORS:null,URL_GET_VISITORS:"/cms/stats/getVisitors",URL_UPDATE_STATISTICS:"/cms/stats/update",$controls:null,$buttonRefresh:null,$buttonRefreshLbl:null,$settingsInput:null,$intervalInputs:null,$intervalButtons:null,$fieldStart:null,$fieldEnd:null,$rangeInputs:null,$visitors:null,$tableOverviewBody:null,settings:null,getInterval:function(){return this.$intervalButtons.filter("."+this.CLASS_BTN_PRIMARY).attr(this.ATTR_INTERVAL)},init:function(){"undefined"!=typeof google&&$("#visitors").length&&(google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(this.renderChart.bind(this)),this.initElements(),this.settings=JSON.parse(this.$settingsInput.val()),this.$rangeInputs.each(this.initRangeInput.bind(this)),this.$intervalButtons.click(this.onIntervalButtonClick.bind(this)),this.$buttonRefresh.click(this.onRefreshClick.bind(this)))},initElements:function(){this.$visitors=$("#visitors"),this.$controls=$(".controls"),this.$settingsInput=this.$controls.find("input[name=settings]"),this.$buttonRefresh=this.$controls.find(".refresh"),this.$rangeInputs=this.$controls.find(".dateRange input"),this.$intervalButtons=this.$controls.find(".interval button"),this.$fieldStart=this.$controls.find(".start"),this.$fieldEnd=this.$controls.find(".end"),this.$tableOverviewBody=$("#tab-overview").find("table tbody"),this.$buttonRefreshLbl=this.$buttonRefresh.find(".lbl"),this.STR_FETCHING_NEW_DATA=KikCMS.translations["statistics.fetchingNewData"],this.STR_FETCHING_FAILED=KikCMS.translations["statistics.fetchingFailed"],this.STR_FETCH_NEW_DATA=KikCMS.translations["statistics.fetchNewData"],this.STR_VISITORS=KikCMS.translations["statistics.visitors"]},initRangeInput:function(t,e){var i=$(e),n={format:this.settings.dateFormat,minDate:this.settings.minDate,maxDate:this.settings.maxDate,useCurrent:!1};i.hasClass(this.CLASS_START)&&(n.defaultDate=this.settings.startDate),i.datetimepicker(n),i.on("dp.change",this.renderChart.bind(this))},onButtonRefreshFadeOut:function(){this.$buttonRefresh.addClass(this.CLASS_LOADING),this.$buttonRefresh.addClass(this.CLASS_BTN_DEFAULT),this.$buttonRefresh.removeClass(this.CLASS_BTN_PRIMARY),this.$buttonRefresh.removeClass(this.CLASS_GLOW),this.$buttonRefreshLbl.text(this.STR_FETCHING_NEW_DATA)},onDataUpdate:function(t){if(!t.success)return this.$buttonRefresh.removeClass(this.CLASS_LOADING),this.$buttonRefresh.addClass(this.CLASS_FAILED),void this.$buttonRefreshLbl.text(this.STR_FETCHING_FAILED);this.$buttonRefresh.removeClass(this.CLASS_LOADING),this.$buttonRefresh.removeClass(this.CLASS_BTN_DEFAULT),this.$buttonRefresh.addClass(this.CLASS_BTN_PRIMARY),this.$buttonRefresh.addClass(this.CLASS_GLOW),this.$buttonRefreshLbl.text(this.STR_FETCH_NEW_DATA),this.$rangeInputs.each(function(){$(this).data("DateTimePicker").maxDate(moment(t.maxDate))})},onIntervalButtonClick:function(t){var e=$(t.target);this.$intervalButtons.removeClass(this.CLASS_BTN_PRIMARY),this.$intervalButtons.addClass(this.CLASS_BTN_DEFAULT),e.addClass(this.CLASS_BTN_PRIMARY),e.removeClass(this.CLASS_BTN_DEFAULT),this.renderChart()},onRefreshClick:function(){return!this.$buttonRefresh.hasClass(this.CLASS_LOADING)&&(this.$buttonRefresh.hasClass(this.CLASS_FAILED)?(this.$buttonRefresh.removeClass(this.CLASS_FAILED),this.$buttonRefresh.addClass(this.CLASS_LOADING),this.$buttonRefreshLbl.text(this.STR_FETCHING_NEW_DATA),this.updateAnalyticsData(),!1):(this.renderChart(),void this.$buttonRefresh.fadeOut(this.onButtonRefreshFadeOut.bind(this))))},populateOverviewTable:function(t){var i="";$.each(t,function(t,e){i+="<tr><td>"+t+":</td><td>"+e+"</td></tr>"}),this.$tableOverviewBody.html(i)},populateVisitorDataTable:function(t,e){var i="";$.each(e,function(t,e){i+="<tr><td><span>"+e.value+"</span></td><td>"+e.visits+'</td><td><span class="percentage" style="width: '+5*e.percentage+'px;"></span>'+e.percentage+"%</td></tr>"}),$("#tab-"+t).find("table tbody").html(i)},renderChart:function(){var t={interval:this.getInterval(),start:this.$fieldStart.val(),end:this.$fieldEnd.val()};KikCMS.action(this.URL_GET_VISITORS,t,this.renderChartWithData.bind(this))},renderChartWithData:function(t){var e={title:this.STR_VISITORS,legend:{position:"bottom"},colors:[this.COLOR_PINK,this.COLOR_BLUE],chartArea:{width:"80%"}},i=new google.visualization.DataTable(t.visitorsData),n=new google.visualization.AreaChart(this.$visitors[0]);this.populateOverviewTable(t.overviewData),$.each(t.visitorData,this.populateVisitorDataTable.bind(this)),n.draw(i,e),t.requiresUpdate?this.updateAnalyticsData():this.$buttonRefresh.fadeOut()},updateAnalyticsData:function(){this.$buttonRefresh.fadeIn();var e=this;KikCMS.getSecurityToken(function(t){$.ajax({url:e.URL_UPDATE_STATISTICS,data:{token:t},success:e.onDataUpdate.bind(e),type:"post",dataType:"json",cache:!1})})}}),statistics=new Statistics;function scaleMenu(){var t=$(window),e=t.height()/t.width();$("#menu").css("min-height",$("#main").outerWidth()*e)}$(function(){statistics.init()}),$(function(){$(".datatable").on("click",".action.link",function(){var t=$(this).parent().find('[data-column="email"]').text().trim(),e=window.location.protocol+"//"+window.location.hostname;window.location.port&&80!==window.location.port&&443!==window.location.port&&(e+=":"+window.location.port),alert(e+"/cms/login/activate?email="+t)})}),$(function(){scaleMenu(),$(window).resize(scaleMenu);var a="kikcms.cacheTreeSelection";$(".tree").each(function(){var e=$(this),t=e.find("input[type=checkbox]"),i=localStorage.getItem(a);if(i)for(var n in i=JSON.parse(i))e.find('[id="'+i[n]+'"]').prop("checked",!0);t.change(function(){var t=[];e.find("input[type=checkbox]:checked").each(function(){t.push($(this).attr("id"))}),localStorage.setItem(a,JSON.stringify(t))})})});var WindowManager=Class.extend({windows:null,closeWindow:function(t,e){var i=this.getOverlayContainer(),n=parseInt(t.data("level"));0==n?($("body").removeClass("datatableBlur"),$("body > #menu").css("top","0"),i.css("z-index",3)):($(".dataTableWindow.level"+(n-1)).removeClass("blur"),i.css("z-index",n+2)),$(".dataTableWindow.level"+(n+1)).remove(),t.fadeOut(),t.find(".windowContent").html(""),void 0!==e&&e()},getNotFadingContainer:function(){var t=$("body > #notFading");return t.length||(t=$('<div id="notFading"></div>'),$("body").append(t)),t},getOverlayContainer:function(){var t=$("body > #overlay");return t.length||(t=$('<div id="overlay"></div>'),$("body").prepend(t)),t},getWindow:function(t,e,i){var n=this,a=this.getNotFadingContainer(),s=e.parentsUntil(".dataTableWindow").parent().attr("data-level"),o=t+"Window",r=0;s&&(o+="Level"+(r=parseInt(s)+1));var l=a.find(" > #"+o);return l.length?a.find(" > #"+o).find(".closeButton").unbind("click"):(l='<div class="dataTableWindow level'+r+'" data-level="'+r+'" id="'+o+'"><div class="closeButton"></div><div class="windowContent"></div></div>',a.prepend(l)),(l=$("#"+o)).find(".closeButton").click(function(){return void 0===i?n.closeWindow(l):i()}),l},showWindow:function(t){var e=this.getOverlayContainer(),i=parseInt(t.attr("data-level"));0==i?($("body").addClass("datatableBlur"),$("body > #menu").css("top",$(window).scrollTop())):($(".dataTableWindow.level"+(i-1)).addClass("blur"),e.css("z-index",i+3)),t.fadeIn()}});